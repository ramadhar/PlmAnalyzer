<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - PLM Log Analyzer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root { /* reuse index design tokens */
        --footer-h:48px; --font-sans:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        --bg-gradient:linear-gradient(135deg,#0b1324 0%,#12263d 55%,#182f49 100%);
        --color-bg:#0e1827; --color-bg-alt:#172537; --color-surface:#1d2c41; --color-surface-alt:#24344b;
        --color-border:#32475d; --color-border-strong:#4a627b; --color-text:#e3e9f2; --color-text-soft:#94a3b8;
        --color-accent:#6366f1; --color-accent-grad:linear-gradient(135deg,#6366f1 0%,#8b5cf6 55%,#ec4899 110%);
        --color-danger:#ef4444; --color-warning:#f59e0b; --color-success:#10b981;
        --radius-xs:4px; --radius-sm:8px; --radius-md:12px; --radius-lg:18px; --radius-pill:999px;
        --shadow-sm:0 2px 4px -1px rgba(0,0,0,.4); --shadow-md:0 4px 14px -2px rgba(0,0,0,.45); --shadow-lg:0 8px 28px -4px rgba(0,0,0,.55);
        --transition-base:.18s cubic-bezier(.4,0,.2,1);
    }
    body {font-family:var(--font-sans);background:var(--bg-gradient);color:var(--color-text);min-height:100vh;}
    * {margin:0;padding:0;box-sizing:border-box;}
    .topbar {display:flex;align-items:center;gap:14px;background:rgba(20,30,46,.78);backdrop-filter:blur(14px);padding:6px 16px;border-radius:0 0 14px 14px;box-shadow:0 4px 14px rgba(0,0,0,.45);border:1px solid #203348;border-top:none;}
    .brand {display:flex;align-items:center;font-size:1rem;font-weight:600;color:var(--color-text);gap:8px;width:220px;}
    .brand i{color:#38bdf8;}
    .top-link {display:flex;align-items:center;gap:6px;color:var(--color-text-soft);text-decoration:none;font-size:.66rem;font-weight:600;padding:6px 10px;border-radius:8px;transition:background var(--transition-base),color var(--transition-base);letter-spacing:.5px;}
    .top-link:hover {background:#1e293b;color:#fff;}
    .top-link.active {background:var(--color-accent-grad);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.4);}        
    .layout {display:flex;height:calc(100vh - 60px);width:100%;}
    .sidebar {width:260px;background:linear-gradient(165deg,var(--color-surface) 0%,var(--color-surface-alt) 120%);color:var(--color-text);display:flex;flex-direction:column;padding:14px 16px;overflow-y:auto;border-right:1px solid var(--color-border);}
    .sidebar-header h2{font-size:1rem;margin-bottom:12px;display:flex;align-items:center;gap:6px;font-weight:600;letter-spacing:.5px;}
    .sidebar-section{margin-bottom:16px;}
    .sidebar-section label{font-size:.6rem;text-transform:uppercase;letter-spacing:.1em;font-weight:600;color:var(--color-text-soft);margin-bottom:6px;display:block;}
    .side-select{width:100%;padding:8px 10px;border:1px solid var(--color-border);border-radius:8px;background:var(--color-bg-alt);color:var(--color-text);font-size:.7rem;}
    .side-select:focus{outline:none;border-color:var(--color-accent);}
    .primary-btn{background:var(--color-accent-grad);border:none;color:#fff;padding:9px 12px;border-radius:8px;font-size:.7rem;font-weight:600;cursor:pointer;box-shadow:var(--shadow-sm);letter-spacing:.6px;}
    .primary-btn:disabled{opacity:.6;cursor:wait;}
    .back-link{margin-top:auto;display:inline-flex;align-items:center;gap:6px;color:var(--color-text-soft);text-decoration:none;font-size:.65rem;padding:6px 0;}
    .back-link:hover{color:#fff;}
    .issue-type{background:var(--color-accent-grad);padding:4px 10px;border-radius:var(--radius-pill);font-size:.55rem;display:inline-block;}
    .main-pane{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:10px 14px 18px 14px;}
    .logs-pane{flex:1;display:flex;flex-direction:column;background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);padding:0;overflow:hidden;}
    .pane-header{padding:10px 16px;font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.12em;background:var(--color-bg-alt);color:var(--color-text);display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--color-border);}
    .code-view{flex:1;margin:0;padding:14px 16px;font-family:Consolas,Monaco,monospace;font-size:12px;line-height:1.34;overflow:auto;white-space:pre;background:#000;color:#d1d5db;}
    .code-view::-webkit-scrollbar{width:10px;} .code-view::-webkit-scrollbar-track{background:#1e293b;} .code-view::-webkit-scrollbar-thumb{background:#475569;border-radius:6px;} .code-view:hover::-webkit-scrollbar-thumb{background:#64748b;}
    .root-cause-box{border-top:1px solid var(--color-border);padding:12px 16px;background:var(--color-surface-alt);} 
    .rc-title{font-size:.6rem;font-weight:700;letter-spacing:.08em;margin-bottom:6px;color:var(--color-text-soft);display:flex;align-items:center;gap:6px;}
    .rc-text{margin:0;font-size:.65rem;white-space:pre-wrap;line-height:1.35;background:#0f1827;color:var(--color-text);border:1px solid var(--color-border);padding:10px 12px;border-radius:8px;max-height:220px;overflow:auto;}
    .timestamp{font-size:.55rem;color:var(--color-text-soft);padding:6px 16px 12px 16px;}
    @media (max-width:960px){.layout{flex-direction:column;} .sidebar{width:100%;flex-direction:row;flex-wrap:wrap;border-right:none;border-bottom:1px solid var(--color-border);} .main-pane{padding:10px;} .sidebar-section{width:160px;margin-right:10px;} .back-link{margin-top:12px;}}
    </style>

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .back-btn i {
            margin-right: 8px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 25px;
            transition: transform 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-5px);
        }

        .result-card h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .result-card h3 i {
            margin-right: 10px;
            color: #667eea;
        }

        .issue-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 15px;
        }

        .issue-scores {
            margin-bottom: 20px;
        }

        .issue-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .issue-score:last-child {
            border-bottom: none;
        }

        .score-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            flex: 1;
            margin: 0 15px;
            overflow: hidden;
        }

        .score-fill {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .score-value {
            font-weight: 600;
            color: #374151;
            min-width: 30px;
            text-align: right;
        }

        .log-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }

        .log-section h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .log-section h3 i {
            margin-right: 10px;
            color: #667eea;
        }

        .log-entry {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e2e8f0;
        }

        .line-number {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .matched-line {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 8px;
            margin: 10px 0;
            font-weight: 600;
            color: #92400e;
        }

        .context-lines {
            color: #6b7280;
            font-size: 0.85rem;
            white-space: pre-wrap; /* preserve original line breaks */
        }

        .root-cause {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .root-cause h4 {
            color: #065f46;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .root-cause p {
            color: #047857;
            line-height: 1.6;
            white-space: pre-line;
        }

        .timestamp {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .result-card, .log-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="brand"><i class="fas fa-microscope"></i><span class="brand-text">PLM Analyzer</span></div>
        <nav class="top-nav" style="display:flex;gap:4px;">
            <a href="/" class="top-link"><i class="fas fa-upload"></i> Upload</a>
            <a href="/duplicate-finder" class="top-link"><i class="fas fa-clone"></i> Duplicates</a>
            <a href="/ai_help" class="top-link"><i class="fas fa-robot"></i> AI Help</a>
            <a href="/smart" class="top-link"><i class="fas fa-shield-alt"></i> Smart Detect</a>
            <span class="top-link active"><i class="fas fa-bug"></i> Issues</span>
        </nav>
    </div>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-bug"></i> Issues</h2>
            </div>
            <div class="sidebar-section">
                <label>Main Issue</label>
                <select id="switch_main" class="side-select"></select>
            </div>
            <div class="sidebar-section">
                <label>Sub Issue</label>
                <select id="switch_sub" class="side-select"></select>
            </div>
            <button id="switch_btn" class="primary-btn" style="margin-top:6px;">Load Issue</button>
            <hr />
            <div class="sidebar-section small-info">
                <div><strong>Selected:</strong><br><span class="issue-type">{{ result.selected_issue }}</span></div>
                <div style="margin-top:8px;"><strong>Method:</strong><br>{{ result.analysis_method }}</div>
                <div style="margin-top:8px;"><strong>Package:</strong><br>{{ result.package_name if result.package_name else 'All' }}</div>
            </div>
            {% if result.log_id %}
            <!-- Metrics & compare removed with eager mode deprecation -->
            {% endif %}
            <a href="{{ url_for('index') }}" class="back-link"><i class="fas fa-arrow-left"></i> New Upload</a>
        </aside>
        <main class="main-pane">
            <section class="logs-pane">
                <div class="pane-header"><i class="fas fa-file-alt"></i><span id="log_view_title">Issue Logs</span></div>
                <pre class="code-view" id="raw_log_pre">{{ result.preview_log if result.preview_log else 'No relevant log lines extracted for this issue.' }}</pre>
                <div class="root-cause-box">
                    <div class="rc-title"><i class="fas fa-lightbulb"></i> Root Cause</div>
                    <pre class="rc-text">{{ result.root_cause }}</pre>
                </div>
                <div class="timestamp">Completed: {{ result.timestamp }}</div>
            </section>
        </main>
    </div>

    <script>
    const logId = "{{ result.log_id if result.log_id else '' }}";
    const issueMap = JSON.parse(`{{ (result.all_issue_types | tojson | safe) if result.all_issue_types else '{}' }}`);
    const currentMain = '{{ result.main_issue_type }}';
    const currentSub = '{{ result.sub_issue_type }}';

        function populateMain() {
            const mainSel = document.getElementById('switch_main');
            if(!mainSel) return;
            mainSel.innerHTML='';
            Object.keys(issueMap).forEach(k=>{
                const o=document.createElement('option');o.value=k;o.textContent=k;if(k===currentMain)o.selected=true;mainSel.appendChild(o);
            });
            populateSub();
        }
    function populateSub(){
            const mainSel=document.getElementById('switch_main');
            const subSel=document.getElementById('switch_sub');
            if(!mainSel||!subSel)return;subSel.innerHTML='';
            (issueMap[mainSel.value]||[]).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;if(mainSel.value===currentMain && s===currentSub)o.selected=true;subSel.appendChild(o);});
        }
        document.addEventListener('change',e=>{if(e.target&&e.target.id==='switch_main'){populateSub();}});
        document.addEventListener('DOMContentLoaded',()=>{try{populateMain();}catch(e){console.error('Populate main failed',e);} });
        document.getElementById('switch_btn')?.addEventListener('click', ()=>{
            const m=document.getElementById('switch_main').value;
            const s=document.getElementById('switch_sub').value;
            if(!logId) { alert('Missing log id'); return; }
            const btn=document.getElementById('switch_btn');
            btn.disabled=true; const old=btn.textContent; btn.textContent='Loading...';
            fetch('/switch_issue',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({log_id:logId,main_issue_type:m,sub_issue_type:s})})
                .then(r=>r.json()).then(data=>{
                    if(data.error){alert(data.error);return;}
                    // Update selected issue label
                    const sel=document.querySelector('.issue-type'); if(sel) sel.textContent=data.selected_issue;
                    // Update log preview
                    const pre=document.getElementById('raw_log_pre'); if(pre) pre.textContent=data.preview_log||'';
                    // Update root cause
                    const rc=document.querySelector('.rc-text'); if(rc) rc.textContent=data.root_cause||'';
                    // Update timestamp
                    const ts=document.querySelector('.timestamp'); if(ts) ts.textContent='Completed: '+data.timestamp;
                })
                .catch(err=>alert(err))
                .finally(()=>{btn.disabled=false; btn.textContent=old;});
        });
    </script>
    {% if result.eager_mode %}
    <script id="preview_payload" type="application/json">{{ result.preview_log|tojson }}</script>
    <script id="summary_payload" type="application/json">{{ result.summary|tojson }}</script>
    <script>
        (function(){
            const pre = document.getElementById('raw_log_pre');
            const btnPrev = document.getElementById('btn_show_preview');
            const btnSum = document.getElementById('btn_show_summary');
            if(!pre || !btnPrev || !btnSum) return;
            const previewText = JSON.parse(document.getElementById('preview_payload').textContent || '""');
            const summaryText = JSON.parse(document.getElementById('summary_payload').textContent || '""');
            function setActive(which){
                if(which==='preview'){
                    pre.textContent = previewText || 'Preview not generated.';
                    btnPrev.style.background='#1e293b';
                    btnSum.style.background='#334155';
                    document.getElementById('log_view_title').textContent='Preview';
                } else {
                    pre.textContent = summaryText || 'Summary not generated.';
                    btnSum.style.background='#1e293b';
                    btnPrev.style.background='#334155';
                    document.getElementById('log_view_title').textContent='Summary';
                }
            }
            btnPrev.addEventListener('click',()=>setActive('preview'));
            btnSum.addEventListener('click',()=>setActive('summary'));
            setActive('preview');
        })();
    </script>
    {% endif %}
</body>
</html>
