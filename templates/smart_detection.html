<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Detection - Log Line Matching</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#0f172a; --panel:#1e293b; --panel-alt:#16243a; --accent:#6366f1; --accent-grad:linear-gradient(135deg,#6366f1 0%,#8b5cf6 55%,#6366f1 100%); --border:#334155; --text:#e2e8f0; --text-soft:#94a3b8; --danger:#dc2626; --radius:12px; }
    body[data-theme='light'] { --bg:#f1f5f9; --panel:#ffffff; --panel-alt:#f8fafc; --border:#d0d7e2; --text:#1e293b; --text-soft:#64748b; }
    *{box-sizing:border-box;} body { margin:0; font-family:Inter,system-ui,sans-serif; background:linear-gradient(180deg,#0f172a,#0b1322); color:var(--text); line-height:1.45; min-height:100vh; display:flex; flex-direction:column; }
    body[data-theme='light']{background:linear-gradient(180deg,#ffffff,#f1f5f9);}    
    .topbar{display:flex;align-items:center;gap:16px;padding:10px 18px;background:#0c1424;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20;}
    body[data-theme='light'] .topbar{background:rgba(255,255,255,.9);backdrop-filter:saturate(1.4) blur(4px);}    
    .top-links{display:flex;gap:4px;} .top-link{display:flex;align-items:center;gap:6px;padding:8px 14px;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.08em;border:1px solid transparent;border-radius:8px;color:var(--text-soft);}
    .top-link:hover{background:#1e293b;color:var(--text);} body[data-theme='light'] .top-link:hover{background:#e2e8f0;color:#1e293b;} .top-link.active{background:var(--accent);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.4);} body[data-theme='light'] .top-link{color:var(--text-soft);}    
    .theme-toggle{border:none;background:transparent;color:var(--text-soft);cursor:pointer;padding:6px 8px;border-radius:8px;font-size:.85rem;display:flex;align-items:center;gap:6px;} .theme-toggle:hover{background:#1e293b;color:var(--text);} body[data-theme='light'] .theme-toggle:hover{background:#e2e8f0;color:#1e293b;}
    .layout { display:flex; flex:1; min-height:0; }
    .side { width:360px; min-width:260px; max-width:60%; background:linear-gradient(145deg,#1e293b 0%,#16243a 110%); border-right:1px solid var(--border); padding:18px 18px 26px; overflow:auto; transition:width .15s ease; display:flex; flex-direction:column; gap:18px; }
    body[data-theme='light'] .side{background:linear-gradient(145deg,#ffffff 0%,#f1f5f9 110%);}    
    .main { flex:1; display:flex; flex-direction:column; background:linear-gradient(145deg,#16243a 0%,#1e293b 110%); }
    body[data-theme='light'] .main{background:linear-gradient(145deg,#f1f5f9 0%,#e8eef5 110%);}    
    .resizer{width:8px;cursor:col-resize;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;background:linear-gradient(180deg,#1e293b,#162e44);border-left:1px solid rgba(255,255,255,.04);border-right:1px solid rgba(255,255,255,.04);} .resizer:after{content:"";width:3px;height:40px;border-radius:2px;background:linear-gradient(180deg,#64748b,#475569);box-shadow:0 0 0 1px rgba(0,0,0,.4);} body[data-theme='light'] .resizer{background:linear-gradient(180deg,#eef2f7,#dde5ef);} body[data-theme='light'] .resizer:after{background:linear-gradient(180deg,#cbd5e1,#94a3b8);box-shadow:0 0 0 1px rgba(255,255,255,.6);} .resizer:hover{filter:brightness(1.08);} body.resizing *{cursor:col-resize!important;user-select:none!important;}
    h1 { font-size:.95rem; margin:0; font-weight:600; letter-spacing:.06em; display:flex; align-items:center; gap:8px; color:#93c5fd; }
    body[data-theme='light'] h1{color:#334155;}
    form#smartForm{display:flex;flex-direction:column;gap:18px;}
  .card{background:linear-gradient(135deg,#142033 0%,#1c2d47 110%);border:1px solid rgba(255,255,255,.05);border-radius:18px;padding:18px 18px 20px;position:relative;box-shadow:0 6px 18px -8px rgba(0,0,0,.65),inset 0 0 0 1px rgba(255,255,255,.03);} .card:before{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle at 85% 20%,rgba(255,255,255,.08),transparent 60%);pointer-events:none;} body[data-theme='light'] .card{background:linear-gradient(135deg,#ffffff 0%,#eef2f7 100%);border:1px solid #d0d7e2;box-shadow:0 4px 14px -6px rgba(0,0,0,.18);} body[data-theme='light'] .card:before{background:radial-gradient(circle at 80% 25%,rgba(0,0,0,.06),transparent 60%);}    
    label { font-size:.58rem; text-transform:uppercase; letter-spacing:.11em; font-weight:700; color:#93c5fd; display:block; margin-bottom:6px; display:flex; align-items:center; gap:6px; }
    label i{color:#6366f1;filter:drop-shadow(0 0 4px rgba(99,102,241,.35));font-size:.65rem;} body[data-theme='light'] label i{filter:none;}
    body[data-theme='light'] label{color:#334155;}
    textarea, input, select { width:100%; background:#0f172a; color:var(--text); border:1.5px solid var(--border); border-radius:10px; padding:10px 12px; font-family:inherit; font-size:.72rem; resize:vertical; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);} body[data-theme='light'] textarea, body[data-theme='light'] input, body[data-theme='light'] select{background:#ffffff;border-color:#cbd5e1;color:#1e293b;} textarea:focus, input:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 1px var(--accent); }
  .mini { font-size:.55rem; color:var(--text-soft); margin-top:6px; line-height:1.25; }
  .range-wrap{display:flex;align-items:center;gap:12px;margin-top:6px;} 
  .range-wrap input[type=range]{flex:1;accent-color:#6366f1;height:8px;background:linear-gradient(90deg,#6366f1,#8b5cf6);border-radius:12px;outline:none;appearance:none;}
  .range-wrap input[type=range]::-webkit-slider-runnable-track{height:8px;border-radius:12px;background:linear-gradient(90deg,#6366f1,#8b5cf6);}
  .range-wrap input[type=range]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);border:2px solid #fff;box-shadow:0 2px 6px -2px rgba(0,0,0,.6);margin-top:-6px;cursor:pointer;}
  .range-wrap input[type=range]::-moz-range-track{height:8px;border-radius:12px;background:linear-gradient(90deg,#6366f1,#8b5cf6);} 
  .range-wrap input[type=range]::-moz-range-thumb{width:20px;height:20px;border:none;border-radius:50%;background:var(--accent);box-shadow:0 2px 6px -2px rgba(0,0,0,.6);cursor:pointer;}
  body[data-theme='light'] .range-wrap input[type=range]{background:linear-gradient(90deg,#6366f1,#8b5cf6);} 
  input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { display:none; }
  input[type=number]{ -moz-appearance: textfield; appearance: textfield; }
  .top-link{white-space:nowrap;line-height:1;}
  .top-link.active{color:#fff !important;}
    .btn { display:inline-flex; align-items:center; gap:6px; border:none; cursor:pointer; background:var(--accent-grad); color:#fff; font-size:.65rem; font-weight:600; padding:11px 18px; border-radius:12px; letter-spacing:.06em; box-shadow:0 4px 14px -4px rgba(0,0,0,.55); }
    .btn:hover{filter:brightness(1.07);} .btn:active{transform:translateY(1px);} .btn:disabled { opacity:.5; cursor:default; }
    .results-bar { background:linear-gradient(135deg,#142033 0%,#1c2d47 110%); border-top:1px solid var(--border); padding:8px 14px; font-size:.58rem; display:flex; flex-wrap:wrap; gap:18px; align-items:center; min-height:42px; }
    body[data-theme='light'] .results-bar{background:linear-gradient(135deg,#ffffff,#f1f5f9);}    
    .pane { flex:1; display:flex; flex-direction:column; }
    .pane h2 { margin:0; font-size:.62rem; font-weight:700; letter-spacing:.12em; background:linear-gradient(135deg,#142033 0%,#1c2d47 110%); padding:10px 16px; color:#93c5fd; text-transform:uppercase; display:flex; align-items:center; gap:8px; }
    body[data-theme='light'] .pane h2{background:#e2e8f0;color:#334155;}
    pre { margin:0; padding:16px 18px 18px; font-family:Consolas,monospace; font-size:11.5px; line-height:1.35; white-space:pre-wrap; word-break:break-word; overflow:auto; flex:1; background:linear-gradient(145deg,#0f172a 0%,#112235 110%); color:#e2e8f0; border-top:1px solid var(--border); box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);} body[data-theme='light'] pre{background:linear-gradient(145deg,#ffffff 0%,#f1f5f9 110%);color:#1e293b;}
    .stats { background:linear-gradient(135deg,#142033 0%,#1c2d47 110%); padding:10px 14px 12px; font-size:.55rem; line-height:1.3; border-top:1px solid var(--border); display:flex; flex-wrap:wrap; gap:12px; }
    body[data-theme='light'] .stats{background:#f1f5f9;}
    .stats div { opacity:.9; }
    .score-high { background:#064e3b; }
    .score-mid { background:#1e3a8a; }
    .score-low { background:#3f3f46; }
    .error { color:var(--danger); font-size:.6rem; margin-top:6px; white-space:pre-wrap; }
    .loading { font-size:.58rem; color:var(--text-soft); padding:4px 2px; }
    .badge-soft{background:rgba(99,102,241,.15);color:#c7d2fe;padding:4px 10px;border-radius:30px;font-size:.55rem;font-weight:600;letter-spacing:.07em;display:inline-flex;align-items:center;gap:6px;} body[data-theme='light'] .badge-soft{background:#e0e7ff;color:#4338ca;}
    .inline-fields{display:flex;gap:12px;}
    .inline-fields .field{flex:1;}
    @media (max-width:1100px){.inline-fields{flex-direction:column;}}
    @media (max-width:900px){.layout{flex-direction:column;} .side{width:100%!important;max-width:none;border-right:none;border-bottom:1px solid var(--border);} .resizer{display:none;} }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="font-weight:600;font-size:.8rem;letter-spacing:.09em;color:#93c5fd;display:flex;align-items:center;gap:8px;"><i class="fas fa-filter"></i> Smart Detection</div>
    <div class="top-links">
      <a class="top-link" href="{{ url_for('index') }}"><i class="fas fa-bug"></i> Logs</a>
      <a class="top-link" href="{{ url_for('duplicate_finder') }}"><i class="fas fa-copy"></i> Duplicates</a>
      <a class="top-link" href="{{ url_for('translate_page') }}"><i class="fas fa-language"></i> Translate</a>
    <a class="top-link active" href="{{ url_for('smart_detection_page') }}"><i class="fas fa-filter"></i> Detect</a>
    <a href="{{ url_for('ai_help_page') }}" class="top-link {% if request.endpoint=='ai_help_page' %}active{% endif %}"><i class="fas fa-robot"></i><span>AI Help</span></a>
    </div>
    <button class="theme-toggle" id="themeToggle" title="Toggle light/dark"><i class="fas fa-adjust"></i></button>
    <div style="flex:1"></div>
    <div style="font-size:.55rem;color:var(--text-soft);">Experimental heuristic + sentiment boost</div>
  </div>
  <div class="layout">
  <div class="side" id="smartSidebar">
      <form id="smartForm">
        <div class="card">
          <h1 style="margin-bottom:14px;"><i class="fas fa-magic"></i> Input</h1>
          <div class="group">
            <label><i class="fas fa-heading"></i> Problem Title</label>
            <input name="problem_title" id="problem_title" placeholder="App crashes when enabling VPN" required />
          </div>
          <div class="group">
            <label><i class="fas fa-align-left"></i> Problem Content / Description</label>
            <textarea name="problem_content" id="problem_content" rows="6" placeholder="Steps, context, expected vs actual behavior..." required></textarea>
            <div class="mini">Clear, specific description improves matching accuracy.</div>
          </div>
          <div class="form-group group">
            <label for="log_file_ai"><i class="fas fa-file-alt"></i> Android Log File</label>
            <div class="file-upload">
                <input type="file" id="log_file_ai" accept=".txt,.log" required>
                <label for="log_file_ai" class="file-upload-label" id="logFileLabel">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span class="lf-name">Choose a log file or drag and drop here</span>
                </label>
                <div class="file-upload-label drag-active"></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:10px;">
              <button type="button" id="clearLogBtn" class="btn" style="background:#475569;padding:7px 12px;font-size:.6rem;flex:0 0 auto;"><i class="fas fa-eraser"></i> Clear</button>
              <div id="logInfo" style="font-size:.55rem;color:var(--text-soft);flex:1;text-align:right;"></div>
            </div>
            <small style="color:var(--text-soft);display:block;margin-top:8px;font-size:.52rem;">Supported: .txt, .log (Max 500MB). Only lines >= threshold overlap returned (max 300).</small>
          </div>
          <div class="group">
            <label><i class="fas fa-percentage"></i> Threshold %</label>
            <div class="range-wrap">
              <input type="range" id="threshold_range" min="10" max="100" value="80" />
            </div>
            <div class="mini" id="thrText">Current: 80%</div>
          </div>
          <div class="group">
            <label><i class="fas fa-list-ol"></i> Max Lines</label>
            <input type="number" id="max_lines" value="300" min="10" max="1000" />
            <div class="mini">Cap returned lines to control volume.</div>
          </div>
          <div class="group">
            <label><i class="fas fa-brain"></i> Model</label>
            <select id="model">
              <option value="heuristic" selected>Heuristic Token Overlap</option>
              <option value="sentiment_lexicon">Sentiment (Lexicon Boost)</option>
            </select>
            <div class="mini">Sentiment model boosts high-overlap lines with negative error tone.</div>
          </div>
          <div class="group" style="margin-top:6px;display:flex;gap:10px;align-items:center;">
            <button type="button" class="btn" id="analyzeBtn"><i class="fas fa-microchip"></i> Analyze Issue</button>
            <div id="status" class="loading" style="flex:1;text-align:right;"></div>
          </div>
          <div id="form_error" class="error" style="display:none;"></div>
        </div>
      </form>
    </div>
  <div class="resizer" id="smartResizer" title="Drag to resize"></div>
  <div class="main">
      <div class="pane" style="display:flex;flex-direction:column;min-height:0;">
        <h2><i class="fas fa-stream"></i> Matched Lines</h2>
        <pre id="lines_view"></pre>
        <div id="stats_panel" class="stats"></div>
      </div>
      <div class="results-bar" id="results_bar"></div>
    </div>
  </div>
  <script>
  (function(){
    const saved=localStorage.getItem('plmTheme');
    if(saved) document.body.dataset.theme=saved; else document.body.dataset.theme='dark';
    document.getElementById('themeToggle')?.addEventListener('click',()=>{const b=document.body; b.dataset.theme = b.dataset.theme==='light'?'dark':'light'; localStorage.setItem('plmTheme', b.dataset.theme);});
  })();
  // Unified upload behavior (mirrors main page)
  const fileInput = document.getElementById('log_file_ai');
  const fileLabel = document.getElementById('logFileLabel');
  const nameSpan = fileLabel.querySelector('.lf-name');
  const infoSpan = document.getElementById('logInfo');
  const clearBtn = document.getElementById('clearLogBtn');
  function fmtMB(bytes){return (bytes/1024/1024).toFixed(2)+' MB';}
  function setFileDisplay(file){
    if(!file){
      nameSpan.textContent='Choose a log file or drag and drop here';
      infoSpan.textContent='';
      fileLabel.style.borderColor='var(--border)';
      return;
    }
    nameSpan.textContent=`${file.name} (${fmtMB(file.size)})`;
    fileLabel.style.borderColor='var(--accent)';
  }
  fileInput.addEventListener('change', e=> setFileDisplay(e.target.files[0]));
  const prevent = e=>{e.preventDefault(); e.stopPropagation();};
  ['dragenter','dragover'].forEach(ev=>fileLabel.addEventListener(ev,e=>{prevent(e); fileLabel.style.borderColor='var(--accent)'; fileLabel.style.background='rgba(99,102,241,.08)';}));
  ['dragleave','drop'].forEach(ev=>fileLabel.addEventListener(ev,e=>{prevent(e); fileLabel.style.borderColor='var(--border)'; fileLabel.style.background='linear-gradient(145deg,#16243a 0%,#132032 100%)';}));
  fileLabel.addEventListener('drop', e=>{const f=e.dataTransfer.files[0]; if(f){ fileInput.files=e.dataTransfer.files; setFileDisplay(f);} });
  clearBtn.addEventListener('click', ()=>{fileInput.value=''; setFileDisplay(null);});
  document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
    const title=document.getElementById('problem_title').value.trim();
    const content=document.getElementById('problem_content').value.trim();
    const fileEl=document.getElementById('log_file_ai');
  const threshold=(parseInt(document.getElementById('threshold_range').value)||80)/100;
    const maxLines=parseInt(document.getElementById('max_lines').value)||300;
    const model=document.getElementById('model').value;
    const errBox=document.getElementById('form_error'); errBox.style.display='none';
    if(!title||!content||!fileEl.files.length){ errBox.textContent='All fields including log file are required.'; errBox.style.display='block'; return; }
    const status=document.getElementById('status'); status.textContent='Reading file...';
    const text=await fileEl.files[0].text();
    status.textContent='Processing on server...';
    try {
      const resp=await fetch('/api/smart_detect', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({problem_title:title, problem_content:content, log_text:text, threshold, max_lines:maxLines, model})});
      if(!resp.ok) throw new Error('Server returned '+resp.status);
      const data=await resp.json();
      const view=document.getElementById('lines_view');
      if(data.error){ view.textContent='Error: '+data.error; status.textContent='Failed.'; return; }
  if(!data.lines.length){ view.textContent='No lines met the threshold.'; }
  else { view.textContent=data.lines.map(l=>`[${l.n} | ${(l.score*100).toFixed(1)}% | base ${l.base_overlap} + boost ${l.booster_overlap}${l.sentiment!==undefined?(' | sent '+l.sentiment.toFixed(2)) : ''}]\n${l.text}\n  tokens: ${l.match_tokens.join(', ')}`).join('\n'); }
  document.getElementById('results_bar').textContent=`Model ${data.model} | scanned ${data.total_lines_scanned} | candidates ${data.total_candidates} | >= thr ${data.above_threshold_count} | returned ${data.returned_count}${data.truncated?' (truncated)':''} | thr ${Math.round(data.threshold*100)}%${data.reboot_mode?' | reboot mode':''}`;
  const stats=document.getElementById('stats_panel');
  stats.innerHTML = `<div>Problem tokens: ${data.problem_tokens.length}</div><div>Booster tokens: ${data.booster_tokens.length}</div><div>Zero-overlap skipped: ${data.zero_overlap}</div><div>Config excluded: ${data.excluded_config}</div><div>Noise excluded: ${data.excluded_noise}</div>`;
      status.textContent='Done.';
    } catch(e){
      document.getElementById('lines_view').textContent='Request failed: '+e.message;
      status.textContent='Error.';
    }
  });
  // Sidebar resize logic
  (function(){
    const resizer=document.getElementById('smartResizer');
    const sidebar=document.getElementById('smartSidebar');
    if(!resizer||!sidebar) return;
    const saved=localStorage.getItem('smartSidebarW');
    if(saved){ const w=parseInt(saved,10); if(w>260 && w<window.innerWidth*0.7) sidebar.style.width=w+'px'; }
    let startX,startW;
    function move(e){ const clientX = e.touches? e.touches[0].clientX : e.clientX; const dx=clientX-startX; let nw=startW+dx; const max=Math.min(window.innerWidth*0.65, window.innerWidth-400); if(nw<260) nw=260; if(nw>max) nw=max; sidebar.style.width=nw+'px'; }
    function up(){ document.body.classList.remove('resizing'); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); window.removeEventListener('touchmove',move); window.removeEventListener('touchend',up); localStorage.setItem('smartSidebarW', parseInt(getComputedStyle(sidebar).width,10)); }
    function down(e){ startX = e.touches? e.touches[0].clientX : e.clientX; startW=parseInt(getComputedStyle(sidebar).width,10); document.body.classList.add('resizing'); window.addEventListener('mousemove',move); window.addEventListener('mouseup',up); window.addEventListener('touchmove',move); window.addEventListener('touchend',up); }
    resizer.addEventListener('mousedown',down); resizer.addEventListener('touchstart',down);
  })();
  // Threshold slider display
  (function(){
    const rng=document.getElementById('threshold_range');
    const txt=document.getElementById('thrText');
    if(!rng||!txt) return;
    function update(){ let v=parseInt(rng.value)||80; if(v<10) v=10; if(v>100) v=100; rng.value=v; txt.textContent='Current: '+v+'%'; }
    rng.addEventListener('input', update); update();
  })();
  </script>
</body>
</html>