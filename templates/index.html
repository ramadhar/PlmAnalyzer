<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLM Log Analyzer - Android Issue Detection</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --footer-h:48px;
        --font-sans:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        /* Dark theme palette */
        --bg-gradient:linear-gradient(135deg,#0b1324 0%,#12263d 55%,#182f49 100%);
        --color-bg:#0e1827;
        --color-bg-alt:#172537;
        --color-surface:#1d2c41;
        --color-surface-alt:#24344b;
        --color-border:#32475d;
        --color-border-strong:#4a627b;
        --color-text:#e3e9f2;
        --color-text-soft:#94a3b8;
        --color-accent:#6366f1;
        --color-accent-grad:linear-gradient(135deg,#6366f1 0%,#8b5cf6 55%,#ec4899 110%);
        --color-danger:#ef4444; --color-warning:#f59e0b; --color-success:#10b981;
        --radius-xs:4px; --radius-sm:8px; --radius-md:12px; --radius-lg:18px; --radius-pill:999px;
        --shadow-sm:0 2px 4px -1px rgba(0,0,0,.4);
        --shadow-md:0 4px 14px -2px rgba(0,0,0,.45);
        --shadow-lg:0 8px 28px -4px rgba(0,0,0,.55);
        --transition-base:.18s cubic-bezier(.4,0,.2,1);
    }
    body[data-theme='light'] {
        --bg-gradient:linear-gradient(120deg,#eff6ff 0%,#f5f3ff 55%,#faf5ff 100%);
        --color-bg:#f1f5f9; --color-bg-alt:#e2e8f0; --color-surface:#ffffff; --color-surface-alt:#f1f5f9;
        --color-border:#cbd5e1; --color-border-strong:#94a3b8; --color-text:#1e293b; --color-text-soft:#475569;
        --color-accent:#4f46e5; --color-accent-grad:linear-gradient(135deg,#4f46e5 0%,#7c3aed 55%,#db2777 110%);
    }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    /* Compact top bar */
    .topbar {display:flex;align-items:center;gap:14px;background:rgba(20,30,46,.78);backdrop-filter:blur(14px);padding:6px 16px;margin:0 0 6px 0;border-radius:0 0 14px 14px;box-shadow:0 4px 14px rgba(0,0,0,.45);border:1px solid #203348;border-top:none;} 
    .brand {display:flex;align-items:center;font-size:1.00rem;font-weight:600;color:var(--color-text);gap:8px;width:240px;flex:0 0 240px;}
    .brand i {color:#38bdf8;font-size:1.05rem;filter:drop-shadow(0 0 4px rgba(56,189,248,.35));}
    .brand-text {letter-spacing:.5px;}
    .info-toggle {border:none;background:transparent;color:#94a3b8;cursor:pointer;font-size:.95rem;padding:4px 6px;border-radius:6px;}
    .info-toggle:hover {color:#f1f5f9;background:#1e293b;}
    .app-blurb {font-size:.68rem;margin:2px 0 6px 6px;letter-spacing:.55px;max-width:880px;transition:opacity .25s,height .25s;font-weight:600;background:linear-gradient(90deg,#38bdf8,#6366f1 35%,#a855f7 70%,#ec4899);-webkit-background-clip:text;background-clip:text;color:transparent;}
    .app-blurb:hover {filter:brightness(1.18);}    
    .app-blurb.hidden {opacity:0;height:0;overflow:hidden;margin:0;}
    .top-nav {display:flex;align-items:center;gap:2px;margin-left:0;}
    @media (max-width:780px){.brand{width:auto;flex:0 0 auto;}.top-nav{flex-wrap:wrap;margin-left:0;}}
    .top-link {display:flex;align-items:center;gap:6px;color:var(--color-text-soft);text-decoration:none;font-size:.68rem;font-weight:600;padding:6px 10px;border-radius:8px;transition:background var(--transition-base),color var(--transition-base);letter-spacing:.55px;}
    body[data-theme='light'] .top-link{color:#334155;}
    body[data-theme='light'] .top-link:hover{background:#e2e8f0;color:#0f172a;}
    body[data-theme='light'] .top-link.active{color:#ffffff;}
    .top-link i {font-size:.75rem;}
    .top-link:hover {background:#1e293b;color:#fff;}
    .top-link.active {background:var(--color-accent-grad);color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.4);}        
    /* Capabilities bar */
    .capabilities{display:flex;flex-wrap:wrap;gap:6px;margin:4px 4px 6px 6px;padding:2px 2px 2px 2px;}
    .cap-item{display:flex;align-items:center;gap:4px;font-size:.60rem;font-weight:600;padding:6px 10px;border-radius:30px;background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:#e2e8f0;letter-spacing:.5px;cursor:default;box-shadow:0 2px 4px rgba(0,0,0,.35);position:relative;}
    .cap-item i{font-size:.65rem;color:#60a5fa;}
    .cap-item:hover{background:linear-gradient(135deg,#374151 0%,#475569 100%);} 
    @media (max-width:720px){.capabilities{margin-top:2px;}.cap-item{font-size:.58rem;padding:5px 8px;}}

    .app-layout{display:flex;gap:12px;height:calc(100vh - 90px - var(--footer-h));margin-top:4px;width:100%;}
    .sidebar{width:320px;min-width:260px;max-width:60%;background:linear-gradient(165deg,var(--color-surface) 0%,var(--color-surface-alt) 120%);border:1px solid var(--color-border);border-radius:var(--radius-lg);padding:16px;overflow:auto;box-shadow:var(--shadow-md);transition:width .15s ease;} 
    .main-area{flex:1;background:linear-gradient(155deg,var(--color-surface) 0%,var(--color-surface-alt) 100%);border:1px solid var(--color-border);border-radius:var(--radius-lg);display:flex;flex-direction:column;overflow:hidden;box-shadow:var(--shadow-md);} 
    .resizer{width:6px;cursor:col-resize;display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative;border-radius:6px;background:linear-gradient(180deg,#1e293b,#0f1827);border:1px solid #233447;box-shadow:0 0 0 1px rgba(255,255,255,.03),0 2px 6px -2px rgba(0,0,0,.55);} 
    .resizer:after{content:"";width:2px;height:38px;border-radius:2px;background:linear-gradient(180deg,#64748b,#475569);box-shadow:0 0 0 1px rgba(0,0,0,.4);} 
    .resizer:hover{background:linear-gradient(180deg,#27374a,#152233);} 
    body[data-theme='light'] .resizer{background:linear-gradient(180deg,#e2e8f0,#cbd5e1);border-color:#cbd5e1;box-shadow:0 2px 6px -2px rgba(0,0,0,.12);} 
    body[data-theme='light'] .resizer:after{background:linear-gradient(180deg,#94a3b8,#64748b);} 
    body.resizing *{cursor:col-resize!important;user-select:none!important;} 
    .main-card{background:transparent;box-shadow:none;padding:0;margin:0;}
    .upload-card{background:var(--color-surface-alt);border:1px solid var(--color-border);border-radius:var(--radius-md);padding:18px 18px 20px 18px;margin-bottom:18px;box-shadow:var(--shadow-sm);}    
    .log-preview-header{padding:10px 14px;font-size:.7rem;font-weight:600;color:var(--color-text);letter-spacing:.09em;text-transform:uppercase;background:var(--color-bg-alt);border-bottom:1px solid var(--color-border);display:flex;align-items:center;gap:6px;}
    .log-preview{flex:1;white-space:pre;font-family:Consolas,monospace;font-size:12px;line-height:1.35;color:#d1d5db;padding:14px 16px;overflow:auto;background:#000;border-top:1px solid var(--color-border);}
    body[data-theme='light'] .log-preview{color:#374151;} 
    .log-preview::selection{background:rgba(99,102,241,.35);color:#fff;}
    .placeholder{display:flex;align-items:center;justify-content:center;color:#94a3b8;font-size:.85rem;height:100%;}
    .hidden{display:none !important;}
    .side-title{color:var(--color-text);font-size:.75rem;font-weight:700;letter-spacing:.08em;margin-bottom:10px;text-transform:uppercase;}
    .side-note{color:var(--color-text-soft);font-size:.62rem;margin-top:4px;line-height:1.3;}
    .form-group label i{color:var(--color-accent);margin-right:6px;filter:drop-shadow(0 0 4px rgba(99,102,241,.35));}
    .form-group label[for=sub_issue_type] i{color:#0ea5e9;}
    .form-group label[for=package_name] i{color:#f59e0b;}
    .form-group label[for=log_file] i{color:#10b981;}
    body[data-theme='light'] .form-group label i{filter:none;}
    .submit-btn{margin-top:10px;}
    .mode-select{background:var(--color-bg-alt);color:var(--color-text);border:1px solid var(--color-border);border-radius:8px;padding:8px;width:100%;font-size:.72rem;}
    select#main_issue_type, select#sub_issue_type {background:var(--color-bg-alt);color:var(--color-text);border:1px solid var(--color-border);}    
    select#main_issue_type option, select#sub_issue_type option {color:var(--color-text);background:var(--color-surface-alt);}    
    .mode-select:focus{outline:none;border-color:#6366f1;}
    .nav-tabs{margin-top:10px;}
    @media (max-width:1200px){.app-layout{flex-direction:column;height:auto;} .sidebar{width:100%;min-width:0;} .main-area{height:60vh;}}
    @media (max-width:1200px){.resizer{display:none;}}

        .form-group {
                margin-bottom: 18px;
                background:linear-gradient(145deg,var(--color-surface-alt) 0%,var(--color-surface) 110%);
                border:1px solid var(--color-border);
                padding:14px 16px 16px 16px;
                border-radius:12px;
                box-shadow:0 2px 6px -2px rgba(0,0,0,.35);
                transition:background .35s,border-color .35s,box-shadow .35s;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text);
            font-size: .9rem;
            letter-spacing: .3px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

    body[data-theme='light'] .form-group {background:linear-gradient(145deg,#ffffff 0%,#f1f5f9 110%);border-color:#d0d7e2;box-shadow:0 2px 6px -2px rgba(0,0,0,.08);}        
    .form-group:focus-within {border-color:var(--color-accent);box-shadow:0 4px 14px -4px rgba(0,0,0,.45);}        
    body[data-theme='light'] .form-group:focus-within {box-shadow:0 4px 14px -4px rgba(99,102,241,.35);}        

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

    .file-upload-label {display:flex;align-items:center;justify-content:center;padding:18px;border:2px dashed var(--color-border);border-radius:var(--radius-md);background:linear-gradient(145deg,var(--color-surface-alt) 0%,var(--color-surface) 100%);cursor:pointer;transition:all var(--transition-base);min-height:76px;}

    .file-upload-label:hover {border-color: var(--color-accent);background:rgba(99,102,241,.08);}        

        .file-upload-label i {
            font-size: 2rem;
            color: var(--color-text-soft);
            margin-right: 15px;
        }

    .file-upload-label span {color:var(--color-text-soft);font-weight:500;}

    .submit-btn {background:var(--color-accent-grad);color:#fff;border:none;padding:16px 34px;border-radius:var(--radius-md);font-size:.8rem;font-weight:600;cursor:pointer;transition:all var(--transition-base);width:100%;text-transform:uppercase;letter-spacing:.6px;position:relative;overflow:hidden;}
    .submit-btn:before {content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(255,255,255,.15),rgba(255,255,255,0),rgba(255,255,255,.12));opacity:0;transition:opacity .4s;}
    .submit-btn:hover:before{opacity:1;}
    .submit-btn:hover {transform:translateY(-2px);box-shadow:0 8px 20px -4px rgba(0,0,0,.55);}        
    .submit-btn:active {transform:translateY(0);} 

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .feature-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .feature-card h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .feature-card p {
            opacity: 0.8;
            line-height: 1.6;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            color: #d97706;
        }

        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            backdrop-filter: blur(10px);
        }

        .nav-tab {
            padding: 12px 24px;
            margin: 0 5px;
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    /* Spinner style reused in dynamic preview loading */
    .preview-loading-spinner {width:34px;height:34px;border:4px solid #334155;border-top:4px solid #60a5fa;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px;}

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-card {
                padding: 25px;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
                gap: 5px;
            }
        }

    /* Light theme explicit overrides (improve nav/link visibility & balanced contrast) */
    body[data-theme='light'] .topbar {background:rgba(255,255,255,.85);border:1px solid var(--color-border);border-top:none;box-shadow:0 4px 14px rgba(0,0,0,.07);}        
    body[data-theme='light'] .brand i {filter:none;color:#0ea5e9;}
    body[data-theme='light'] .info-toggle {color:#64748b;}
    body[data-theme='light'] .info-toggle:hover {background:#e2e8f0;color:#1e293b;}
    body[data-theme='light'] .top-link {color:#475569;}
    body[data-theme='light'] .top-link:hover {background:#e2e8f0;color:#111827;}
    body[data-theme='light'] .top-link.active {color:#fff;}
    body[data-theme='light'] .cap-item {background:linear-gradient(135deg,#f1f5f9 0%, #e2e8f0 100%);color:#1e293b;border:1px solid #cbd5e1;box-shadow:0 2px 4px rgba(15,23,42,.08);}        
    body[data-theme='light'] .cap-item i {color:#0ea5e9;}
    body[data-theme='light'] .cap-item:hover {background:linear-gradient(135deg,#e2e8f0 0%, #cbd5e1 100%);}        
    body[data-theme='light'] .sidebar {background:linear-gradient(165deg,#ffffff 0%,#f1f5f9 120%);}        
    body[data-theme='light'] .main-area {background:linear-gradient(155deg,#ffffff 0%,#f1f5f9 100%);}        
    body[data-theme='light'] .upload-card {background:#ffffff;}        
    body[data-theme='light'] .log-preview-header {background:#e2e8f0;color:#1e293b;}        
    body[data-theme='light'] .log-preview {background:#f8fafc;color:#334155;border-top:1px solid var(--color-border);}        
    body[data-theme='light'] .file-upload-label {background:linear-gradient(145deg,#f1f5f9 0%,#ffffff 100%);border-color:#cbd5e1;}        
    body[data-theme='light'] .file-upload-label:hover {background:#eef2f6;border-color:#94a3b8;}        
    body[data-theme='light'] .placeholder {color:#64748b;}        
    body[data-theme='light'] .side-note {color:#64748b;}        
    body[data-theme='light'] .submit-btn {box-shadow:0 4px 12px -3px rgba(99,102,241,.35);}        
    body[data-theme='light'] .submit-btn:hover {box-shadow:0 8px 18px -4px rgba(99,102,241,.45);}        
    body[data-theme='light'] .nav-tab {color:#475569;}        
    body[data-theme='light'] .nav-tab:hover {background:rgba(0,0,0,.06);}        
    body[data-theme='light'] .nav-tab.active {background:#4f46e5;color:#fff;border-color:#4f46e5;}        
    /* Footer adaptations */
    body[data-theme='light'] .footer-bar {background:rgba(255,255,255,.85);border-top:1px solid var(--color-border);box-shadow:0 -2px 8px rgba(0,0,0,.05);}        
    body[data-theme='light'] .f-pill {background:linear-gradient(135deg,#f1f5f9 0%, #e2e8f0 100%);color:#475569;border:1px solid #cbd5e1;}        
    body[data-theme='light'] .f-pill i {color:#0ea5e9;}        
    body[data-theme='light'] .f-pill:hover {background:linear-gradient(135deg,#e2e8f0 0%, #cbd5e1 100%);color:#1e293b;}        
    body[data-theme='light'] .f-btn {background:#ffffff;border:1px solid #cbd5e1;color:#475569;}        
    body[data-theme='light'] .f-btn:hover {background:#f1f5f9;color:#1e293b;border-color:#94a3b8;}        
    body[data-theme='light'] .footer-bar.collapsed {background:rgba(255,255,255,.65);}        
    /* Smooth theme transition */
    body {transition:background-color .35s, color .35s;}        
    .topbar, .sidebar, .main-area, .footer-bar, .cap-item, .file-upload-label, .submit-btn, .f-pill, .f-btn {transition:background .35s,color .35s,border-color .35s,box-shadow .35s;}        
    /* Additional interactive light-mode accents */
    body[data-theme='light'] {--surface-accent:#eef2ff;--surface-accent-soft:#f5f7ff;--surface-accent-hover:#e0e7ff;--surface-warn:#fff7ed;--surface-success:#ecfdf5;--surface-danger:#fef2f2;}
    body[data-theme='light'] .upload-card:hover {box-shadow:0 6px 18px -6px rgba(0,0,0,.18);}
    body[data-theme='light'] .sidebar {position:relative;}
    body[data-theme='light'] .sidebar:before {content:"";position:absolute;inset:0;border-radius:var(--radius-lg);pointer-events:none;background:linear-gradient(145deg,rgba(79,70,229,.08),rgba(124,58,237,.04));opacity:.9;}
    body[data-theme='light'] .cap-item {background:var(--surface-accent-soft);}        
    body[data-theme='light'] .cap-item:hover {background:var(--surface-accent-hover);}        
    body[data-theme='light'] .file-upload-label {background:linear-gradient(145deg,#ffffff 0%,var(--surface-accent-soft) 100%);}        
    body[data-theme='light'] .file-upload-label:focus-within {border-color:var(--color-accent);background:var(--surface-accent);}        
    body[data-theme='light'] .file-upload-label.drag-active {border-color:var(--color-accent);background:var(--surface-accent);}        
    body[data-theme='light'] .top-link:focus-visible {outline:2px solid var(--color-accent);outline-offset:2px;}        
    body[data-theme='light'] .submit-btn {background:var(--color-accent-grad);}        
    body[data-theme='light'] .log-preview-header {border-bottom:2px solid var(--color-accent);}        
    /* Status background helpers (future use) */
    .bg-warn{background:var(--surface-warn)!important;}
    .bg-success{background:var(--surface-success)!important;}
    .bg-danger{background:var(--surface-danger)!important;}
    </style>
</head>
<body>
    <div class="container" style="max-width:100%;padding-top:0;">
        {% if ai_mode %}
        <div style="position:fixed;top:8px;right:-40px;transform:rotate(45deg);background:linear-gradient(135deg,#6366f1,#8b5cf6,#ec4899);color:#fff;padding:6px 60px;font-size:.55rem;font-weight:700;letter-spacing:.15em;box-shadow:0 4px 10px rgba(0,0,0,.35);z-index:1000;pointer-events:none;">AI MODE</div>
        {% endif %}
        <!-- Compact top bar -->
        <div class="topbar">
            <div class="brand" title="Android Log Issue Detection">
                <i class="fas fa-bug"></i><span class="brand-text">PLM Analyzer</span>
                <button class="info-toggle" id="infoToggle" title="Toggle description"><i class="fas fa-info-circle"></i></button>
                <button class="info-toggle" id="themeToggle" title="Toggle light/dark"><i class="fas fa-adjust"></i></button>
            </div>
            <div class="top-nav">
                <a href="{{ url_for('index') }}" class="top-link {% if request.endpoint=='index' %}active{% endif %}"><i class="fas fa-file-medical"></i><span>Logs</span></a>
                <a href="{{ url_for('duplicate_finder') }}" class="top-link {% if request.endpoint=='duplicate_finder' %}active{% endif %}"><i class="fas fa-copy"></i><span>Duplicates</span></a>
                <a href="{{ url_for('translate_page') }}" class="top-link {% if request.endpoint=='translate_page' %}active{% endif %}"><i class="fas fa-language"></i><span>Translate</span></a>
                <a href="{{ url_for('ai_help_page') }}" class="top-link {% if request.endpoint=='ai_help_page' %}active{% endif %}"><i class="fas fa-robot"></i><span>AI Help</span></a>
            </div>
        </div>
    <div class="app-blurb" id="appBlurb">Intelligent Android Issue Detection & Root Cause Analysis {% if ai_mode %}<span style="font-size:.65rem;padding:4px 8px;margin-left:6px;border:1px solid #6366f1;border-radius:20px;background:rgba(99,102,241,.15);color:#cbd5ff;letter-spacing:.08em;">Semantic Enabled</span>{% endif %}</div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else 'warning' if category == 'warning' else 'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

                <div class="app-layout">
                    <div class="sidebar">
                        <div class="side-title">Upload & Options</div>
                        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="analyzeForm" class="upload-card">
                <div class="form-group">
                    <label for="log_file">
                        <i class="fas fa-file-alt"></i> Android Log File
                    </label>
                    <div class="file-upload">
                        <input type="file" id="log_file" name="log_file" accept=".txt,.log" required>
                        <label for="log_file" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Choose a log file or drag and drop here</span>
                        </label>
                    </div>
                    <small style="color: #6b7280; margin-top: 5px; display: block;">
                        Supported formats: .txt, .log (Max size: 500MB)
                    </small>
                </div>

                <div class="form-group">
                    <label for="main_issue_type">
                        <i class="fas fa-exclamation-triangle"></i> Main Issue Type
                    </label>
                    <select id="main_issue_type" name="main_issue_type" required>
                        <option value="">Select main issue type...</option>
                        <option value="Audio Issues">Audio Issues</option>
                        <option value="Camera Issues">Camera Issues</option>
                        <option value="App Crashes">App Crashes</option>
                        <option value="UI Issues">UI Issues</option>
                        <option value="Network Issues">Network Issues</option>
                        <option value="Memory Issues">Memory Issues</option>
                        <option value="Multimedia Issues">Multimedia Issues</option>
                        <option value="Bluetooth Issues">Bluetooth Issues</option>
                        <option value="App Installation">App Installation</option>
                        <option value="Battery Issues">Battery Issues</option>
                        <option value="Storage Issues">Storage Issues</option>
                        <option value="Security Issues">Security Issues</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sub_issue_type">
                        <i class="fas fa-info-circle"></i> Sub-Issue Type
                    </label>
                    <select id="sub_issue_type" name="sub_issue_type" required>
                        <option value="">Select sub-issue type...</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="package_name">
                        <i class="fas fa-box"></i> Package Name (Optional)
                    </label>
                    <input type="text" id="package_name" name="package_name" 
                           placeholder="e.g., com.samsung.android.app, com.example.app">
                    <small style="color: #6b7280; margin-top: 5px; display: block;">
                        Enter package name to filter logs for specific app only
                    </small>
                </div>


                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-search"></i> Analyze Logs & Detect Issues
                </button>
                        </form>
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p style="color:#f8fafc;font-size:.8rem;">Analyzing logs...</p>
                        </div>
                    </div>
                    <div class="resizer" id="sidebarResizer" title="Drag to resize sidebar"></div>
                    <div class="main-area" id="previewArea">
                        <div class="log-preview-header"><i class="fas fa-file-code"></i> Focused Log Preview</div>
                        <pre class="log-preview" id="logPreview"><div class="placeholder" id="previewPlaceholder">Upload a log file to preview its contents here.</div></pre>
                    </div>
                </div>

        <div class="footer-bar" id="footerBar">
            <div class="footer-left">
                <a href="{{ url_for('smart_detection_page') }}" class="f-pill" style="text-decoration:none;" title="AI assisted semantic log analysis"><i class="fas fa-shield-alt"></i><span>Smart Detection</span></a>
                <div class="f-pill" title="Pattern & rule extraction"><i class="fas fa-search"></i><span>Pattern Analysis</span></div>
                <div class="f-pill" title="Evidence-backed probable causes"><i class="fas fa-chart-line"></i><span>Root Cause</span></div>
            </div>
            <div class="footer-actions">
                <button class="f-btn" id="clearPreview" title="Clear focused preview"><i class="fas fa-eraser"></i></button>
                <button class="f-btn" id="clearCacheBtn" title="Clear cache files"><i class="fas fa-trash"></i></button>
                <button class="f-btn" id="scrollTop" title="Scroll to top"><i class="fas fa-arrow-up"></i></button>
                <button class="f-btn" id="toggleFooter" title="Collapse footer"><i class="fas fa-chevron-down"></i></button>
            </div>
        </div>
    </div>

    <script>
        // Floating dependency manager button (bottom-right)
        (function(){
            const btn=document.createElement('button');
            btn.innerHTML='<i class="fas fa-boxes"></i>';
            btn.title='Dependency Manager';
            btn.setAttribute('aria-label','Open Dependency Manager');
            const applyTheme=()=>{
                const light=document.body.dataset.theme==='light';
                if(light){
                    btn.style.background='linear-gradient(135deg,#4f46e5,#7c3aed,#db2777)';
                    btn.style.border='1px solid #4f46e5';
                    btn.style.color='#ffffff';
                    btn.style.boxShadow='0 4px 14px -4px rgba(79,70,229,.45)';
                } else {
                    btn.style.background='linear-gradient(135deg,#6366f1,#8b5cf6,#ec4899)';
                    btn.style.border='1px solid #6366f1';
                    btn.style.color='#fff';
                    btn.style.boxShadow='0 4px 16px -4px rgba(0,0,0,.65),0 0 0 1px rgba(255,255,255,.05)';
                }
            };
            btn.style.position='fixed';
            btn.style.right='18px';
            btn.style.bottom='72px';
            btn.style.width='54px';
            btn.style.height='54px';
            btn.style.borderRadius='16px';
            btn.style.cursor='pointer';
            btn.style.zIndex='1200';
            btn.style.fontSize='1.05rem';
            btn.style.display='flex';
            btn.style.alignItems='center';
            btn.style.justifyContent='center';
            btn.style.transition='transform .25s,filter .35s';
            applyTheme();
            btn.onmouseenter=()=>{btn.style.transform='translateY(-5px) scale(1.05)'; btn.style.filter='brightness(1.08)';};
            btn.onmouseleave=()=>{btn.style.transform='translateY(0) scale(1)'; btn.style.filter='brightness(1)';};
            btn.onclick=()=>{ window.location.href='/dependencies'; };
            // Re-apply theme when toggled
            const mo=new MutationObserver(applyTheme); mo.observe(document.body,{attributes:true,attributeFilter:['data-theme']});
            document.body.appendChild(btn);
        })();
        // File upload preview
        document.getElementById('log_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const label = document.querySelector('.file-upload-label');
            
            if (file) {
                label.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                `;
                label.style.borderColor = '#10b981';
                label.style.background = '#ecfdf5';
            }
        });

        // Issue type mapping
        const issueTypes = {
            'Audio Issues': ['Noise in Audio', 'Multiple Audio Output', 'Audio Not Working'],
            'Camera Issues': ['Camera Not Launched', 'Camera Rotated', 'Camera Crashes'],
            'App Crashes': ['App Force Stop', 'App Crashes', 'ANR in App', 'Device Reboot'],
            'UI Issues': ['Layout Problems', 'UI Crashes'],
            'Network Issues': ['Connection Problems', 'HTTP Errors'],
            'Memory Issues': ['Out of Memory'],
            'Multimedia Issues': ['Video Playback', 'Media Streaming', 'Codec Issues'],
            'Bluetooth Issues': ['Connection Problems', 'Audio Issues', 'Pairing Issues'],
            'App Installation': ['Install Failures', 'Update Issues', 'Permission Denied'],
            'Battery Issues': ['Drain Problems', 'Charging Issues', 'Power Management'],
            'Storage Issues': ['Space Problems', 'File Corruption', 'SD Card Issues'],
            'Security Issues': ['Permission Denied', 'Authentication Failed', 'Root Detection']
        };

        // Populate sub-issue types when main issue type changes
        document.getElementById('main_issue_type').addEventListener('change', function() {
            const mainType = this.value;
            const subTypeSelect = document.getElementById('sub_issue_type');
            
            // Clear existing options
            subTypeSelect.innerHTML = '<option value="">Select sub-issue type...</option>';
            
            if (mainType && issueTypes[mainType]) {
                issueTypes[mainType].forEach(subType => {
                    const option = document.createElement('option');
                    option.value = subType;
                    option.textContent = subType;
                    subTypeSelect.appendChild(option);
                });
            }
        });

        // Form submission with loading state
        document.getElementById('analyzeForm').addEventListener('submit', function() {
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
        });

        // Drag and drop functionality
        const dropZone = document.querySelector('.file-upload-label');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.style.borderColor = '#667eea';
            dropZone.style.background = '#f0f4ff';
        }

        function unhighlight(e) {
            dropZone.style.borderColor = '#d1d5db';
            dropZone.style.background = '#f9fafb';
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('log_file').files = files;
            
            if (files.length > 0) {
                const file = files[0];
                const label = document.querySelector('.file-upload-label');
                label.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                `;
                label.style.borderColor = '#10b981';
                label.style.background = '#ecfdf5';
            }
        }

// Focused client-side preview (build props, crash stacks, am_crash) BEFORE upload.
(function(){
    const fileInput = document.getElementById('log_file');
    const previewEl = document.getElementById('logPreview');
    if(!fileInput || !previewEl) return;

    const BUILD_KEYS = [
        'ro.bootimage.build.fingerprint',
        'ro.system.build.fingerprint',
        'ro.build.version.sdk',
        'ro.system.build.version.sdk',
        'ro.build.version.release',
        'ro.build.flavor',
        'ro.system.build.type',
        'ro.build.display.id',
        'ro.product.model',
        'ro.product.system.model',
        'ro.product.vendor.device',
        'ro.product.locale',
        'ro.csc.sales_code',
        'ro.csc.country_code',
        'ro.com.google.gmsversion',
        'ro.com.google.clientidbase.pg2'
    ];

    function buildFocusedPreview(text){
        const lines = text.split(/\r?\n/);
        const out = [];
        function addSection(t){ if(out.length && out[out.length-1] !== '') out.push(''); out.push('==== ' + t + ' ===='); }
                // 1. Build / system properties (scan entire file, then alias mapping)
                const wanted = new Set(BUILD_KEYS);
                const found = {};
                const propRe = /^\s*\[(ro\.[^\]]+)\]:\s*\[([^\]]*)\]/;
                for(let i=0;i<lines.length;i++){
                    const m = propRe.exec(lines[i]);
                    if(!m) continue;
                    const k = m[1];
                    if(wanted.has(k) && !(k in found)) found[k] = { line: i+1, val: m[2] };
                }
                const aliasMap = {
                    'ro.bootimage.build.fingerprint': ['ro.system.build.fingerprint','ro.build.fingerprint'],
                    'ro.system.build.fingerprint': ['ro.build.fingerprint','ro.bootimage.build.fingerprint']
                };
                Object.keys(aliasMap).forEach(primary=>{
                    if(!(primary in found)){
                        aliasMap[primary].some(alt=>{
                            if(found[alt]){ found[primary] = { line: found[alt].line, val: found[alt].val + ' (alias from '+alt+')'}; return true; }
                            return false;
                        });
                    }
                });
                addSection('Build / System Properties');
                BUILD_KEYS.forEach(k=>{ out.push('['+k+']: ['+(found[k]?found[k].val:'NOT FOUND')+']'); });

                // 2. Crash stacks
                const fatalRe = /FATAL EXCEPTION/i;
                const frameRe = /^\s*at /;
                const causedRe = /^Caused by:/;
                const timestampRe = /^\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d{3}/;
                for(let i=0;i<lines.length;i++){
                    if(fatalRe.test(lines[i])){
                        addSection('Crash Stack');
                        out.push(lines[i]);
                        let captured=0, sawFrame=false;
                        for(let j=i+1;j<lines.length;j++){
                            const ln = lines[j];
                            if(fatalRe.test(ln) && j!==i) break;
                            if(!ln.trim()){ out.push(''); break; }
                            if(frameRe.test(ln) || causedRe.test(ln)){ sawFrame=true; out.push(ln); }
                            else { if(!sawFrame && !timestampRe.test(ln)) out.push(ln); else break; }
                            captured++; if(captured>=80){ out.push('... (stack truncated) ...'); break; }
                        }
                    }
                }

                // 3. am_crash events
                const amCrashRe = /am_crash/i;
                const amHits = [];
                for(let i=0;i<lines.length;i++) if(amCrashRe.test(lines[i])) amHits.push(i);
                if(amHits.length){
                    addSection('ActivityManager Crash Events (am_crash)');
                    amHits.forEach(pos=>{
                        const start=Math.max(0,pos-1), end=Math.min(lines.length,pos+2);
                        for(let j=start;j<end;j++){
                            const marker=j===pos?'>':' ';
                            out.push(marker+' '+lines[j]);
                        }
                        out.push('');
                    });
                    if(out[out.length-1]==='') out.pop();
                }

        if(!out.length) return 'No build properties, crash stacks, or am_crash events detected in initial scan.';
        // Soft cap lines to 800 similar to server
        if(out.length > 800) return out.slice(0,800).concat(['... (preview truncated at 800 lines) ...']).join('\n');
        return out.join('\n');
    }

    fileInput.addEventListener('change', function(){
        const f = this.files && this.files[0];
        if(!f){previewEl.textContent='';return;}
            previewEl.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:.7rem;color:#cbd5e1;">'+
                '<div class="preview-loading-spinner"></div>'+
                '<div id="previewProgress">Reading file ('+(f.size/1024/1024).toFixed(1)+' MB)...</div>'+
                '</div>';
            const reader = new FileReader();
            reader.onprogress = function(e){
                if(e.lengthComputable){
                    const pct = ((e.loaded / e.total)*100).toFixed(1);
                    const progEl = document.getElementById('previewProgress');
                    if(progEl) progEl.textContent = 'Reading file '+pct+'% ('+(f.size/1024/1024).toFixed(1)+' MB)...';
                }
            };
            reader.onload = function(e){
                try {
                    const text = e.target.result || '';
                    const progEl = document.getElementById('previewProgress');
                    if(progEl) progEl.textContent = 'Processing (scanning entire file)...';
                    // Allow UI paint
                    setTimeout(()=>{
                        const result = buildFocusedPreview(text);
                        previewEl.textContent = result;
                    }, 30);
                } catch(err){
                    previewEl.textContent = 'Failed to build focused preview: '+err;
                }
            };
            reader.onerror = function(){
                previewEl.textContent = 'Error reading file.';
            };
            reader.readAsText(f); // Read entire file regardless of size (may take time)
    });
})();

// Toggle description to free vertical space
document.getElementById('infoToggle')?.addEventListener('click',()=>{
    const b=document.getElementById('appBlurb');
    if(!b) return; b.classList.toggle('hidden');
});

    // Add progress indicator in preview area during form submit
    const analyzeForm = document.getElementById('analyzeForm');
    if(analyzeForm){
        analyzeForm.addEventListener('submit', function(){
            const previewEl = document.getElementById('logPreview');
            if(previewEl){
                previewEl.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;font-size:.75rem;color:#cbd5e1;">'+
                    '<div class="spinner" style="width:34px;height:34px;border:4px solid #334155;border-top:4px solid #60a5fa;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px;"></div>'+
                    '<div>Uploading & analyzing log (Step 1: Upload / Step 2: Focused Preview / Step 3: Issue Analyses)...</div>'+
                    '</div>';
            }
        });
    }
    </script>
    <style>
    /* Footer bar styles themed */
    .footer-bar{position:fixed;left:0;right:0;bottom:0;height:var(--footer-h);display:flex;align-items:center;justify-content:space-between;padding:6px 14px;background:rgba(12,18,30,.94);backdrop-filter:blur(12px);border-top:1px solid var(--color-border);z-index:40;font-size:.65rem;}
    .footer-left{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
    .f-pill{display:flex;align-items:center;gap:5px;padding:6px 10px;border-radius:20px;background:linear-gradient(135deg,#1d2836 0%,#263445 100%);color:var(--color-text-soft);font-weight:600;letter-spacing:.4px;box-shadow:0 2px 4px rgba(0,0,0,.35);font-size:.6rem;border:1px solid #2f4259;transition:background var(--transition-base),color var(--transition-base);} 
    .f-pill i{font-size:.7rem;color:#5fb2ff;transition:color var(--transition-base);} 
    .f-pill:hover{background:linear-gradient(135deg,#2a3b4e 0%,#33475d 100%);color:var(--color-text);}   
    .footer-actions{display:flex;align-items:center;gap:6px;}
    .f-btn{background:#1d2836;border:1px solid #2f4259;color:var(--color-text-soft);border-radius:8px;padding:6px 8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.7rem;transition:background var(--transition-base),border-color var(--transition-base),color var(--transition-base),transform .25s;}
    .f-btn:hover{background:#2a3b4a;color:var(--color-text);border-color:#3d566f;}
    .f-btn:active{transform:scale(.92);} 
    .footer-bar.collapsed{height:20px;overflow:hidden;padding:2px 10px;}
    .footer-bar.collapsed .footer-left,.footer-bar.collapsed .f-pill{display:none;}
    .footer-bar.collapsed #toggleFooter i{transform:rotate(180deg);} 
    @media (max-width:760px){.footer-bar{font-size:.6rem;}.f-pill{display:none;} .footer-bar{justify-content:flex-end;}}
    /* Scrollbar refinement */
    .log-preview::-webkit-scrollbar{width:10px;}
    .log-preview::-webkit-scrollbar-track{background:rgba(255,255,255,.03);}
    .log-preview::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--color-accent) 0%,#8b5cf6 100%);border-radius:6px;}
    .log-preview::-webkit-scrollbar-thumb:hover{filter:brightness(1.1);}  
    </style>
    <script>
    // Footer interactions
    document.getElementById('clearPreview')?.addEventListener('click',()=>{const el=document.getElementById('logPreview'); if(el) el.textContent='';});
    document.getElementById('scrollTop')?.addEventListener('click',()=>window.scrollTo({top:0,behavior:'smooth'}));
    document.getElementById('toggleFooter')?.addEventListener('click',()=>{const fb=document.getElementById('footerBar'); fb?.classList.toggle('collapsed');});
    document.getElementById('clearCacheBtn')?.addEventListener('click', async()=>{
        if(!confirm('Clear all cached files and analyses?')) return;
        try{
            const resp = await fetch('/admin/clear_cache',{method:'POST'});
            if(!resp.ok) throw new Error('Server '+resp.status);
            const data = await resp.json();
            const freedMB = (data.bytes_freed/1024/1024).toFixed(2);
            alert(`Cache cleared. Freed ${freedMB} MB (files removed: ${data.files_removed}, dirs: ${data.dirs_removed}).`);
        }catch(e){alert('Failed to clear cache: '+e.message);}    
    });
    // Theme toggle
    document.getElementById('themeToggle')?.addEventListener('click',()=>{
        const b=document.body; b.dataset.theme = b.dataset.theme==='light'?'dark':'light';
        localStorage.setItem('plmTheme', b.dataset.theme);
    });
    (function(){const saved=localStorage.getItem('plmTheme'); if(saved){document.body.dataset.theme=saved;}})();
    // Sidebar resizer logic
    (function(){
        const resizer=document.getElementById('sidebarResizer');
        const sidebar=document.querySelector('.sidebar');
        const layout=document.querySelector('.app-layout');
        if(!resizer||!sidebar||!layout) return;
        const savedW=localStorage.getItem('plmSidebarW');
        if(savedW){ const w=parseInt(savedW,10); if(w>260 && w<window.innerWidth*0.75) sidebar.style.width=w+'px'; }
        let startX,startW;
        function onMove(e){
            const dx=e.clientX-startX; let newW=startW+dx;
            const max = Math.min(window.innerWidth*0.65, window.innerWidth - 420); // keep preview usable
            if(newW<260) newW=260; if(newW>max) newW=max;
            sidebar.style.width=newW+'px';
        }
        function onUp(){
            document.body.classList.remove('resizing');
            window.removeEventListener('mousemove',onMove);
            window.removeEventListener('mouseup',onUp);
            const w=parseInt(getComputedStyle(sidebar).width,10); localStorage.setItem('plmSidebarW', w);
        }
        resizer.addEventListener('mousedown', e=>{
            startX=e.clientX; startW=parseInt(getComputedStyle(sidebar).width,10);
            document.body.classList.add('resizing');
            window.addEventListener('mousemove',onMove);
            window.addEventListener('mouseup',onUp);
        });
        // Touch support
        resizer.addEventListener('touchstart', e=>{ const t=e.touches[0]; startX=t.clientX; startW=parseInt(getComputedStyle(sidebar).width,10); document.body.classList.add('resizing'); window.addEventListener('touchmove',onTouchMove); window.addEventListener('touchend',onTouchEnd); });
        function onTouchMove(e){ const t=e.touches[0]; onMove(t); }
        function onTouchEnd(){ document.body.classList.remove('resizing'); window.removeEventListener('touchmove',onTouchMove); window.removeEventListener('touchend',onTouchEnd); const w=parseInt(getComputedStyle(sidebar).width,10); localStorage.setItem('plmSidebarW', w); }
    })();
    </script>
</body>
</html>
